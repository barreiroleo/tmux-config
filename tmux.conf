# Changing prefix from 'Ctrl+b' to 'Alt+a'.
# Alt=Meta: Has the same code as Escape. Is a trouble with vim, quit escape-time solve it.
# -g: global option; -a: append to string option

# Remove defaults: prefix, split horizontal, split vertical
unbind-key C-b; unbind-key '"'; unbind-key %

set-option -g focus-events on
set-option -g prefix M-a
bind-key M-a send-prefix

# True color support.
# Escape time > 0 prevents echo escape sequences at start.
set-option -g default-terminal "tmux-256color"
set-option -ga terminal-overrides ",$TERM:RGB"
set-option -s escape-time 1

# Index panes and tabs start in 1. Better for keyword.
# Time for repeat a binding. Mouse.
set-option -g base-index 1
set-option -g pane-base-index 1
set-option -g renumber-windows on
set-option -g repeat-time 2000

# History, vi-mode and mouse
set-option -g history-limit 50000
set-option -g mode-keys vi
set-option -g mouse on
bind-key -n C-l              send-keys C-l \; send-keys -R \; clear-history
bind-key -T copy-mode-vi 'v' send-keys -X begin-selection
bind-key -T copy-mode-vi 'y' send-keys -X copy-selection-no-clear
bind-key -T copy-mode-vi MouseDragEnd1Pane send-keys -X copy-selection-no-clear
set -s set-clipboard on

# Moving between panes.
bind-key h select-pane -L
bind-key j select-pane -D
bind-key k select-pane -U
bind-key l select-pane -R

# Resize panes.
bind-key -r H resize-pane -L 1
bind-key -r J resize-pane -D 1
bind-key -r K resize-pane -U 1
bind-key -r L resize-pane -R 1

# Split windows or panes
bind-key "\\" split-window -h -c "#{pane_current_path}"
bind-key "/"  split-window -h -c "#{pane_current_path}"
bind-key "-"  split-window -v -c "#{pane_current_path}"
bind-key c    new-window      -c "#{pane_current_path}"

bind-key -n M-g if-shell -F '#{==:#{session_name},scratch}' { detach-client } {
  display-popup -d "#{pane_current_path}" -w 80% -h 80% -E "tmux new-session -A -s scratch"
}
bind-key d display-menu -T "#[align=centre]Config" -x C -y C \
    ".zshrc"            z  'display-popup -w 75% -h 75% -E "nvim ~/.zshrc"' \
    ".zshenv"           e  'display-popup -w 75% -h 75% -E "nvim ~/.zshenv"' \
    ".tmux.conf"        t  'display-popup -w 75% -h 75% -E "nvim ~/.config/tmux/tmux.conf"' \
    ".nvim"             v  'display-popup -w 75% -h 75% -d "~/dotfiles/nvim/.config/nvim" -E "nvim"' \
    "dotfiles"          d  'display-popup -w 75% -h 75% -d "~/dotfiles/" -E "zsh"' \
    "quit"              q  ""

bind-key P choose-tree -Zw "join-pane -t '%%'"
%if '#{e|>=|f:#{s/\^next-//:version},3.2}'
  bind -N 'Interactively select a window and \*p\*ush current pane there' P
%endif

bind-key M-p choose-tree -Zs "join-pane -t '%%'"
%if '#{e|>=|f:#{s/\^next-//:version},3.2}'
  bind -N 'Interactively select a session and \*p\*ush current pane there' M-p
%endif

bind u choose-tree -Z "join-pane -s '%%'"
%if '#{e|>=|f:#{s/\^next-//:version},3.2}'
  bind -N 'Interactively select a pane and p\*u\*ll it into the current window' u
%endif

bind-key r source-file ~/.config/tmux/tmux.conf ';' display "Reloaded"

# Launch Todo file
# bind-key -r t new-window -c "#{pane_current_path}" "[[ -e todo.md ]] && nvim todo.md || nvim ~/todo.md"

##########
# Status line
# [RIGHT_A> RIGHT_B>  [LEFT_C WIN | WIN RIGHT_C]  <LEFT_A <LEFT_B]
##########
set-option -g status-left-length   120
set-option -g status-right-length  120
set-option -g status-interval      1
set-option -g status-justify       absolute-centre

HALF_ROUND_RIGHT="#(printf '\uE0B4')"   # 
HALF_ROUND_LEFT="#(printf '\uE0B6')"    # 

RIGHT_A="#[fg=white,bg=colour241]${HALF_ROUND_RIGHT}"
RIGHT_B="#[fg=colour241,bg=black]${HALF_ROUND_RIGHT}"
RIGHT_C="#[fg=white,bg=black]${HALF_ROUND_RIGHT}#[fg=colour241,bg=black]"
LEFT_A="#[fg=colour241,bg=black]${HALF_ROUND_LEFT}#[fg=white,bg=colour241]"
LEFT_B="#[fg=white,bg=colour241]${HALF_ROUND_LEFT}#[fg=black,bg=white]"
LEFT_C="#[fg=white,bg=black]${HALF_ROUND_LEFT}#[fg=black,bg=white]"

# Statusbar - Free space
set-option -g status-style      bg=black,fg=white

# Statusbar - Left / Right
set-option -g status-left       "#{tmux_mode_indicator}${RIGHT_A} #S ${RIGHT_B} #{network-ip} "
set-option -g status-right      "${LEFT_A}#{network-speed} | #{network-ping} ${LEFT_B} #h "

# Statusbar - Window status
set-window -g window-status-current-format  "${LEFT_C}#I:#W#F${RIGHT_C}"
set-window -g window-status-format          " #I:#W#F "
set-window -g window-status-separator       ""

# Statusbar - Window panes
set-option -g pane-border-format            "( #{pane_current_command} )"
set-option -g pane-active-border-style      bg=default,fg="#777777",dim
set-option -g pane-border-style             bg=default,fg="#555555",dim
set-option -g pane-border-lines             single
set-hook   -g window-layout-changed         "set-window -F pane-border-status '#{?#{==:#{window_panes},1},off,top}'"

##########
# Plugins
##########

# Tmux Plugin Manager
set-option -g @plugin 'tmux-plugins/tpm'

set-option -g @plugin 'MunifTanjim/tmux-mode-indicator'
set-option -g @mode_indicator_empty_prompt      " TMUX "
set-option -g @mode_indicator_prefix_prompt     " WAIT "
set-option -g @mode_indicator_copy_prompt       " COPY "
set-option -g @mode_indicator_sync_prompt       " SYNC "
set-option -g @mode_indicator_empty_mode_style  "bg=white,fg=black,bold"
set-option -g @mode_indicator_prefix_mode_style "bg=green,fg=black,bold"
set-option -g @mode_indicator_copy_mode_style   "bg=colour202,fg=black,bold"
set-option -g @mode_indicator_sync_mode_style   "bg=red,fg=black"

set-option -g @plugin 'barreiroleo/tmux-net-speed'
set-option -g @download_speed_format "%10s"
set-option -g @upload_speed_format   "%10s"

set-option -g @plugin 'barreiroleo/myblocks'
set-option -g @myblocks_toggle "on"
# set-option -g @net_interfaces 'wlan0:wlan eth0:eth' # <Physical_name>:<alias>

# Initialize TPM (keep this at bottom),
if "tst ! -d ~/.config/tmux/plugins/tpm" \
   "run 'git clone https://github.com/tmux-plugins/tpm ~/.config/tmux/plugins/tpm && ~/.config/tmux/plugins/tpm/bin/install_plugins'"
run '~/.config/tmux/plugins/tpm/tpm'
